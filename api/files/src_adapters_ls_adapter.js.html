<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/adapters/ls_adapter.js - ember-restless</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.7.0/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify.css">
    <link rel="stylesheet" href="../assets/css/yuidoc.css" id="site_styles">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap-responsive.min.css">
    <link rel="stylesheet" href="../assets/css/yuidoc-bootstrap.css">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-skin-sam">
<div class="navbar navbar-static-top">
    <div class="navbar-inner">
        <div class="container">
            <h1 class="brand">
                
                ember-restless
            </h1>
        	<ul class="nav">
                <li class="divider-vertical"></li>
                <li>
                    <p class="navbar-text">
                        API Docs for Version: <b>0.5.3</b>
                    </p>
                </li>
            </ul>
            <form class="navbar-form pull-right" style="line-height: 40px; height: 40px;">
                <input style="margin-top: 0;" type="text" class="search-query" placeholder="Search for classes/modules..." data-obj='["classes/RESTless", "classes/RESTless.Adapter", "classes/RESTless.Client", "classes/RESTless.FixtureAdapter", "classes/RESTless.JSONSerializer", "classes/RESTless.LSAdapter", "classes/RESTless.Model", "classes/RESTless.ReadOnlyModel", "classes/RESTless.RecordArray", "classes/RESTless.RESTAdapter", "classes/RESTless.Serializer", "classes/RESTless.State", "modules/ember-restless"]'>
            </form>
        </div>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="span3">
	    <div>
    <h3>APIs</h3>
    <div id="sidebar" data-spy="affix" data-offset-top="80">
        <ul id="main-nav" class="nav nav-tabs" style="margin-bottom:0;">
            <li class="active"><a href="#classes" data-toggle="tab">Classes</a></li>
            <li><a href="#modules" data-toggle="tab">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" placeholder="Type to filter APIs">
        </div>

        <div class="tab-content" style="border: 1px solid #DDD; border-top:0;">
            <div class="tab-pane active" id="classes">
                <ul id="api-classes" class="nav nav-list">
                    
                        <li><a href="../classes/RESTless.html">RESTless</a></li>
                    
                        <li><a href="../classes/RESTless.Adapter.html">RESTless.Adapter</a></li>
                    
                        <li><a href="../classes/RESTless.Client.html">RESTless.Client</a></li>
                    
                        <li><a href="../classes/RESTless.FixtureAdapter.html">RESTless.FixtureAdapter</a></li>
                    
                        <li><a href="../classes/RESTless.JSONSerializer.html">RESTless.JSONSerializer</a></li>
                    
                        <li><a href="../classes/RESTless.LSAdapter.html">RESTless.LSAdapter</a></li>
                    
                        <li><a href="../classes/RESTless.Model.html">RESTless.Model</a></li>
                    
                        <li><a href="../classes/RESTless.ReadOnlyModel.html">RESTless.ReadOnlyModel</a></li>
                    
                        <li><a href="../classes/RESTless.RecordArray.html">RESTless.RecordArray</a></li>
                    
                        <li><a href="../classes/RESTless.RESTAdapter.html">RESTless.RESTAdapter</a></li>
                    
                        <li><a href="../classes/RESTless.Serializer.html">RESTless.Serializer</a></li>
                    
                        <li><a href="../classes/RESTless.State.html">RESTless.State</a></li>
                    
                </ul>
            </div>

            <div class="tab-pane" id="modules">
                <ul id="api-modules" class="nav nav-list">
                    
                        <li><a href="../modules/ember-restless.html">ember-restless</a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</div>

        </div>
        <div class="span9">
                <form id="options-form" class="form-inline pull-right">
        Show:
        <label for="api-show-inherited" class="checkbox">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected" class="checkbox">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private" class="checkbox">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated" class="checkbox">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </form>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <div class="page-header">
    <h1>src/adapters/ls_adapter.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
/**
 * The LocalStorageAdapter uses browser&#x27;s localStorage as persistence storage
 *
 * We save the following metadata per model in _modelsMeta array
 * {
 *   keys: []          //Array of all the keys generated in order
 *   circularLimit: &lt;&gt; //Maximum number of items that can be saved (-1 for 
 *                     //unlimited items)
 * }
 *
 * @class LSAdapter
 * @namespace RESTless
 * @extends RESTless.Adapter
 */
RESTless.LSAdapter = RESTless.Adapter.extend({

  /*
   * serializer: default to a JSON serializer
   */
  serializer: RESTless.JSONSerializer.create(),

  /*
   * saveRecord: Saves data to localStorage
   */
  saveRecord: function(record) {
    var deferred = Ember.RSVP.defer(),
        primaryKey = get(record.constructor, &#x27;primaryKey&#x27;),
        isNew = record.get(&#x27;isNew&#x27;),
        dataStoreName = this._getDSName(record),
        dataStore = this._getDataStore(record),
        modelMeta = this._getModelMeta(record);

    /*
     * If primaryKey is not provided, we must generate it from tail value and
     * insert depending on circularLimit
     */
    record.set(&#x27;isSaving&#x27;, true);
    if(isNone(record.get(primaryKey))) {
      dataStore = this._itemInsert(record);
    } else {
      dataStore[record.get(primaryKey)] = record.__data;
      // If key is not already stored, save it
      if(modelMeta.keys.indexOf(record.get(primaryKey)) === -1) {
        modelMeta.keys.push(record.get(primaryKey));
        this._updateModelMeta(modelMeta, dataStoreName);
      }
    }

    try{
      localStorage.setItem(dataStoreName, JSON.stringify(dataStore));
      record.onSaved(isNew);
      deferred.resolve(record);
    } catch (err) {
      record.onError(err);
      deferred.reject(err);
    }

    return deferred.promise;
  },

  /*
   * deleteRecord: Deletes a record from localStorage datastore
   */
  deleteRecord: function(record) {
    var deferred = Ember.RSVP.defer(),
        dataStoreName = this._getDSName(record),
        dataStore = this._getDataStore(record),
        primaryKey = get(record.constructor, &#x27;primaryKey&#x27;),
        key = record.get(primaryKey),
        modelMeta = this._getModelMeta(record);

    if(dataStore[key]) {
      if(modelMeta &amp;&amp; modelMeta.keys) {
        modelMeta.keys.splice(modelMeta.keys.indexOf(key), 1);
      }
      delete(dataStore[key]);
      try{
        // Put the array back in LS
        localStorage.setItem(dataStoreName, JSON.stringify(dataStore));
        this._updateModelMeta(modelMeta, dataStoreName);
        record.onDeleted();
        deferred.resolve(record);
      } catch (err) {
        record.onError(err);
        deferred.reject(err);
      }
    }

    return deferred.promise;
  },

  /*
   * reloadRecord: Reload data into record from dataStore
   */
  reloadRecord: function(record) {
    var deferred = Ember.RSVP.defer(),
        primaryKey = get(record.consturctor, &#x27;primaryKey&#x27;),
        key = record.get(primaryKey),
        dataStoreName = this._getDSName(record),
        dataStore = this._getDataStore(record),
        recordFromKey = this.recordByKey(dataStore, key);

    if(recordFromKey) {
      record.deserialize(recordFromKey);
      record.onLoaded();
      deferred.resolve(record);
    } else {
      record.onError(&#x27;error&#x27;);
      deferred.reject(&#x27;error&#x27;);
    }

    return deferred.promise;
  },

  /*
   * findAll: Returns all the records
   */
  findAll: function(model) {
    return this.findQuery(model);
  },

  /*
   * findQuery: Query a record
   */
  findQuery: function(model, queryParams) {
    var resourceInstance = model.create({ isNew: false }),
        result = RESTless.RecordArray.createWithContent(),
        dataStoreName = this._getDSName(resourceInstance),
        dataStore = this._getDataStore(resourceInstance),
        items = [], itemsA;

    for(var key in dataStore) {
      if(dataStore[key]) {
        items.push(dataStore[key]);
      }
    }

    itemsA = Ember.A(items);
    if(queryParams) {
      itemsA = itemsA.filter(function(item, index, enumerable) {
        for(var key in queryParams) {
          if(queryParams.hasOwnProperty(key) &amp;&amp; item[key] !== queryParams[key]) {
            return false;
          }
        }
        return true;
      }); 
    }
    result.deserializeMany(model.toString(), itemsA);
    result.onLoaded();
    return result;
  },

  /*
   * findByKey: Find a record by given key
   */
  findByKey: function(model, key, queryParams) {
    var result = model.create({isNew: false}),
        dataStoreName = this._getDSName(result),
        dataStore = this._getDataStore(result),
        primaryKey = get(model, &#x27;primaryKey&#x27;),
        recordFromKey = this.recordByKey(dataStore, key);

    if(recordFromKey) {
      result.deserialize(recordFromKey);
      result.onLoaded();
      return result;
    }

    return null;
  },

  /*
   * deleteAll: Deletes all records
   */
  deleteAll: function(model) {
    var deferred = Ember.RSVP.defer(),
        resourceName = get(model, &#x27;resourceName&#x27;),
        dataStore = localStorage.getItem(resourceName),
        record = model.create({isNew: true}),
        modelMeta = this._getModelMeta(record);

    modelMeta.keys = [];
    this._updateModelMeta(modelMeta, resourceName);
    if(dataStore) {
      try{
        delete(localStorage[resourceName]);
        deferred.resolve();
      } catch (err) {
        deferred.reject(err);
      }
    } else {
      deferred.resolve();
    }

    return deferred.promise;
  },

  /*
   * Returns record by key
   */
  recordByKey: function(dataStore, key) {
    if(dataStore[key]) {
      return dataStore[key];
    } else {
      return null;
    }
  },

  /*
   * Modifies circularLimit value. If we have more items, this will truncate
   * the dataStore. -1 is for unlimited storage
   */
  setCircularLimit: function(model, climit) {
    var record = model.create({isNew: true}),
        dataStoreName = this._getDSName(record),
        dataStore = this._getDataStore(record),
        modelMeta = this._getModelMeta(record),
        keys = modelMeta.keys,
        circularLimit = modelMeta.circularLimit;

    if(climit &lt;= 0) { 
      modelMeta.circularLimit = -1;
    } else {
      // If we have more data than new limit, delete overflowing data
      if(keys.length &gt; climit) {
        for(var i = 0; i &lt; keys.length - climit; i++) {
          delete(dataStore[keys[i]]);
        }
        localStorage.setItem(dataStoreName, JSON.stringify(dataStore));
        keys.splice(0, keys.length - climit);
        modelMeta.keys = keys;
        modelMeta.circularLimit = climit;
      }
    }
    this._updateModelMeta(modelMeta, dataStoreName);
  },

  /*
   * getDSName: Returns dataStore name for this resource in localStorage
   */
  _getDSName: function(record) {
    return get(record.constructor, &#x27;resourceName&#x27;);
  },

  /*
   * Returns dataStore from localStorage for this resource
   */
  _getDataStore: function(record) {
    var dSName = this._getDSName(record),
        dataStore = localStorage.getItem(dSName);
            
    if(!dataStore) {
      return {};
    }

    return JSON.parse(dataStore);
  },

  /*
   * Inserts item into the datastore reading circular limit
   */
  _itemInsert: function(record) {
    var primaryKey = get(record.constructor, &#x27;primaryKey&#x27;),
        dataStoreName = this._getDSName(record),
        dataStore = this._getDataStore(record),
        modelMeta = this._getModelMeta(record),
        keys = modelMeta.keys,
        circularLimit = modelMeta.circularLimit,
        key = (keys.length &gt; 0) ? keys[keys.length - 1] + 1 : 0;
    // If circularLimit is not -1, then we need to limit number of entries
    // that could be saved
    if(circularLimit &gt;= 0) {
      // Check if we have maxed out on total number of items
      if(circularLimit - keys.length &lt;= 0) {
        delete(dataStore[keys[0]]);
        keys.splice(0, 1);
      }
      record.set(primaryKey, key);
      dataStore[key] = record.__data;
      keys.push(key);
    } else {
      // Insert and increment tail since we can store unlimited items
      record.set(primaryKey, key);
      dataStore[key] = record.__data;
      keys.push(key);
    }

    modelMeta.keys = keys;
    this._updateModelMeta(modelMeta, dataStoreName);
    return dataStore;
  },

  /*
   * Returns meta data associated with this model
   */
  _getModelMeta: function(record) {
    var dataStoreName = this._getDSName(record),
        dataStore = this._getDataStore(record);

    // Get meta data for this model. Insert if not available already
    var modelsMeta = localStorage.getItem(&#x27;_modelsMeta&#x27;);

    if(isNone(modelsMeta)) {
      modelsMeta = {};
      localStorage.setItem(&#x27;_modelsMeta&#x27;, JSON.stringify(modelsMeta));
    } else {
      modelsMeta = JSON.parse(modelsMeta);
    }

    var modelMeta = modelsMeta[dataStoreName];

    if(isNone(modelMeta)) {
      var cLimit = get(record.constructor, &#x27;circularLimit&#x27;);

      if(isNone(cLimit) || cLimit.isNaN) {
        cLimit = -1;
      }

      modelMeta = {
        keys: [],
        circularLimit: cLimit
      };

      modelsMeta[dataStoreName] = modelMeta;
      localStorage.setItem(&#x27;_modelsMeta&#x27;, JSON.stringify(modelsMeta));
    }
    return modelMeta;
  },

  /*
   * Replaces meta data of given model with provided meta data
   */
  _updateModelMeta: function(modelMeta, dataStoreName) {
    var modelsMeta = localStorage.getItem(&#x27;_modelsMeta&#x27;);

    if(isNone(modelsMeta)) {
      modelsMeta = {};
      localStorage.setItem(&#x27;_modelsMeta&#x27;, JSON.stringify(modelsMeta));
    } else {
      modelsMeta = JSON.parse(modelsMeta);
    }

    modelsMeta[dataStoreName] = modelMeta;
    localStorage.setItem(&#x27;_modelsMeta&#x27;, JSON.stringify(modelsMeta));
  }
});

/*
 * reopenClass to add deleteAll and setCircularLimit as properties
 */
RESTless.Model.reopenClass({
  /*
   * deleteAll: Delete all records
   */
  deleteAll: function(params) {
    return get(this, &#x27;adapter&#x27;).deleteAll(this, params);
  },

  /*
   * setCircularLimit: Updates circular limit value
   */
  setCircularLimit: function(climit) {
    return get(this, &#x27;adapter&#x27;).setCircularLimit(this, climit);
  }
});


    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/jquery/jquery-1.10.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="../assets/vendor/prettify/prettify.min.js"></script>
<script src="../assets/js/yuidoc-bootstrap.js"></script>
<script>prettyPrint();</script>
</body>
</html>
